
# 개발 가이드 :: 주문과 잔고처리 :: 기본설명

## [개요]
OpenAPI를 이용하면 국내주식과 코스피200 지수선물/옵션을 거래할 수 있습니다.  
상품별로 전용 주문함수가 있으며 SendOrderCredit()함수를 이용해서 대주를 제외한 신용주문을 지원합니다.  
※ 정정주문은 원주문에 대한 가격정정만 가능하며 거래구분을 변경하는 정정주문은 지원하지 않습니다.


## [계좌비밀번호 설정]
OpenAPI는 로그인 후 한번 계좌비밀번호를 입력/등록 해야 합니다.  
계좌비밀번호 설정은 계좌비밀번호 입력창에서만 가능합니다.  
이 입력창을 출력하는 방법은 2가지로 제공됩니다.  
1. 메뉴이용 - 로그인후 윈도우의 작업표시줄상에 깜박이는 트레이아이콘의  
마우스우측 메뉴(모니터 오른쪽 하단)에서 "계좌비밀번호 저장" 선택
2. 함수이용 - 로그인후 OpenAPI.KOA_Functions(_T("ShowAccountWindow"), _T("")) 호출
### ※ 계좌비밀번호 입력시 주의할 점 :
OpenAPI는 계좌비밀번호를 검증하지 않고 입력된 값을 그대로 암호화하여 서버로 전송합니다.  
계좌비밀번호 오류가 일어나지 않도록 오타 등 입력에 주의하시기 바랍니다.


## [주문처리단계]

### [1] 주문 처리 순서

   SendOrder(주문발생) -> OnReceiveTRData(주문응답) -> OrderResultMsg(주문메세지수신) -> OnReceiveChejan(주문접수/체결)

#### ※ 주의(역전현상) : 
주문건수가 폭증하는 경우 OnReceiveChejan 이벤트가 OnReceiveTRData 이벤트보다 앞서 수신될 수 있습니다.

### [2] 각 단계 설명  
SendOrder - 사용자가 호출. 리턴값 0인 경우 정상  
OnReceiveTRData - 주문발생시 첫번째 서버응답. 주문번호 취득 (주문번호가 없다면 주문거부 등 비정상주문)  
OrderResultMsg - 주문거부 사유를 포함한 서버메세지 수신  
OnReceiveChejan - 주문 상태에따른 실시간수신 (주문접수, 주문체결, 잔고변경 각 단계별로 수신됨)

OnReceiveTRData()이벤트는 주로 조회요청후 데이터수신 이벤트지만 주문시에도 발생됩니다.   
주문이 정상인 경우 이 이벤트내부에서 주문번호를 얻을 수 있습니다.  
비정상주문인 경우 주문번호는 공백("")으로 전달됩니다.  
각 주문함수의 리턴값이 0(성공)이여도 장 개시전 주문, 시장가 주문가격입력, 호가범위를 벗어난 주문등 다양한 원인으로 주문은 실패할수 있습니다.


## [주문 유의사항]
※ 주문은 1초당 5회로 제한 됩니다. (조회횟수와는 별개로 카운트 됩니다.)  
※ 주문가능수량 이상으로 주문하는 경우 미수주문으로 처리될 수 있습니다.  
영웅문4 [0398] 화면등에서 계좌증거금 변경등록으로 100% 현금 주문만 가능하도록 설정할 수 있습니다.  
※ 시장가주문시 최대주문가능수량은 상한가를 기준으로 계산됩니다.  
※ 시장가주문시 주문가격은 0으로 입력합니다.  
※ OpenAPI에서는 거래구분 정정주문은 지원되지 않습니다.  

   예) 지정가 매도 -> 시장가 매도로 정정 (불가. 원주문 취소 후 신규주문으로 진행하시기 바랍니다.)

※ 주문내역은 영웅문HTS, MTS 등 매체간 공유됩니다.  
타매체에서 발생시킨 주문체결도 OnReceiveChejan 이벤트로 실시간 수신됩니다.  
※ 모의투자 서버에서는 주문 불가 종목이 존재합니다.  
모의투자 규정을 확인해주시기 바랍니다.  
https://www.kiwoom.co.kr/nkw.templateFrameSet.do?m=m1101020000


## [주문체결, 잔고 수신]
OnReceiveChejan()이벤트는 주문접수, 체결, 잔고변경시 발생됩니다.  
이 이벤트를 통해 대부분의 주문관련 정보를 얻을 수 있습니다.  
주문요청에 대한 응답은 주문접수, 주문체결, 잔고수신 순서로 진행됩니다.  
(정정/취소 주문의 경우 주문접수 후에 주문확인 신호가 한번 더 수신됩니다.)  
하나의 주문에대해 부분체결되는 경우 아래와 같은 순서로 OnReceiveChejan 이벤트가 발생됩니다.

   주문 ---> 접수 ---> 체결1 ---> 잔고1  ---> 체결2  ---> 잔고2... ---> 체결n  ---> 잔고n

주문 응답의 구분은 OnReceiveChejanData()이벤트가 발생될때 전달되는 sGubun값을 이용합니다.  
sGubun값은 접수와 체결시 '0'값, 잔고변경은 '1'값을 가지게 됩니다.  
이값에 따라 실시간타입 "주문체결" 또는 "잔고" 타입이 사용됩니다.


## [OnReceiveChejan()이벤트로 전달되는 FID목록정리]

   "9201" : "계좌번호"  
   "9203" : "주문번호"  
   "9001" : "종목코드"  
   "913" : "주문상태"  
   "302" : "종목명"  
   "900" : "주문수량"  
   "901" : "주문가격"  
   "902" : "미체결수량"  
   "903" : "체결누계금액"  
   "904" : "원주문번호"  
   "905" : "주문구분"  
   "906" : "매매구분"  
   "907" : "매도수구분"  
   "908" : "주문/체결시간"  
   "909" : "체결번호"  
   "910" : "체결가"  
   "911" : "체결량"  
   "10" : "현재가"  
   "27" : "(최우선)매도호가"  
   "28" : "(최우선)매수호가"  
   "914" : "단위체결가"  
   "915" : "단위체결량"  
   "919" : "거부사유"  
   "920" : "화면번호"  
   "917" : "신용구분"  
   "916" : "대출일"  
   "930" : "보유수량"  
   "931" : "매입단가"  
   "932" : "총매입가"  
   "933" : "주문가능수량"  
   "945" : "당일순매수수량"  
   "946" : "매도/매수구분"  
   "950" : "당일총매도손일"  
   "951" : "예수금"  (지원안함)  
   "307" : "기준가"  
   "8019" : "손익율"  
   "957" : "신용금액"  
   "958" : "신용이자"  
   "918" : "만기일"  
   "990" : "당일실현손익(유가)"  
   "991" : "당일실현손익률(유가)"  
   "992" : "당일실현손익(신용)"  
   "993" : "당일실현손익률(신용)"  
   "397" : "파생상품거래단위"  
   "305" : "상한가"  
   "306" : "하한가"  
